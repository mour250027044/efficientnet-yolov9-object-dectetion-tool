# 07_additive_context.yaml (FIXED - This is your new Full Model)
nc: 80

backbone:
  - [-1, 1, EfficientNetBackbone, ["efficientnet_b3", True, [2, 3, 4]]] # 0

head:
  - [-1, 1, Adapter, [1280, 256]] # 1
  - [-1, 1, FABlock, [256]] # 2
  - [-1, 1, MyHGBlock, [256, 256, 3, 1]] # 3
  - [-1, 1, SPDADown, [384]] # 4
  - [-1, 1, FABlock, [384]] # 5
  - [-1, 1, MyHGBlock, [384, 384, 3, 1]] # 6
  - [-1, 1, Adapter, [512, 256]] # 7
  - [-1, 1, DropBlock, [0.1]] # 8
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 9
  - [[-1, 5], 1, Concat, [1]] # 10
  - [-1, 1, Adapter, [640, 384]] # 11
  - [-1, 1, FABlock, [384]] # 12
  - [-1, 1, CBAM, [384]] # 13
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 14
  - [[-1, 2], 1, Concat, [1]] # 15
  - [-1, 1, Adapter, [640, 256]] # 16
  - [-1, 1, FABlock, [256]] # 17
  - [-1, 1, CBAM, [256]] # 18 (P3 out)
  - [-1, 1, SPDADown, [256]] # 19
  - [[-1, 11], 1, Concat, [1]] # 20
  - [-1, 1, Adapter, [640, 384]] # 21
  - [-1, 1, FABlock, [384]] # 22
  - [-1, 1, CBAM, [384]] # 23 (P4 out)
  - [-1, 1, SPDADown, [384]] # 24
  - [[-1, 7], 1, Concat, [1]] # 25
  - [-1, 1, Adapter, [640, 512]] # 26
  - [-1, 1, FABlock, [512]] # 27
  - [-1, 1, CBAM, [512]] # 28 (P5 out)

  # Context modules added to P5 branch
  - [-1, 1, ASPP, [512, [1, 6, 12, 18]]] # 29 (ADDED)
  - [-1, 1, SPPF, [512, 5]] # 30 (ADDED)

  # Prepare detection heads
  - [18, 1, Adapter, [256, 96]] # 31 (from P3, layer 18)
  - [23, 1, Adapter, [384, 160]] # 32 (from P4, layer 23)
  - [30, 1, Adapter, [512, 192]] # 33 (from P5, layer 30)

  # Detect head
  - [[31, 32, 33], 1, Detect, [nc]] # 34
